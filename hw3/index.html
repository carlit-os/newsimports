<!DOCTYPE html>
<!-- for reference, see:
  -- https://dev.to/luispa/lets-try-react-without-nodejs-3a7
  -- https://reactjs.org/docs/hello-world.html
  -->
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>React Local</title>
  <script type="application/javascript" src="https://unpkg.com/react@16.0.0/umd/react.development.js"></script>
  <script type="application/javascript" src="https://unpkg.com/react-dom@16.0.0/umd/react-dom.development.js"></script>
  <script type="application/javascript" src="https://unpkg.com/babel-standalone@6.26.0/babel.js"></script>

  <!-- your custom CSS goes here: -->
  <style>
    em{font-weight: bolder}

    .box{
      text-align: center;

      }

    .loader{
      text-align: center;
    }



  </style>

  <!-- Maybe you want to use bootstrap to make it pretty? -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

</head>

<body>
  <div id="root"></div>

  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

  <script type="text/babel">
  // Obtain the root
  const rootElement = document.getElementById('root')

  class SearchApp extends React.Component {
    constructor(props) {
      super(props);
      this.handleClick = this.handleClick.bind(this);
      this.handleType = this.handleType.bind(this);
      this.handleMore = this.handleMore.bind(this);
      this.handleLess = this.handleLess.bind(this);
      this.handleChecked = this.handleChecked.bind(this);
      this.handleTime = this.handleTime.bind(this);
      this.updateFetch = this.updateFetch.bind(this);
      this.state = {
        clicked : false,
        searchResults : "",
        sequence : 0,
        count : 10,
        query : "",
        lang : "",
        isChecked: false,
        daySet: "",
        dayBox: "",
        sequence: 0
      }
    }

    handleClick(e) {
      var boxy = "&date="+this.state.dayBox
      this.setState({daySet:boxy})
      this.handleType("time",boxy)
    }


    handleType(e,d){ //handle searchbox changes
      //this.seqence = this.seqence + 1 //convert to setState
      this.setState({clicked: true});

      var strCount = this.state.count.toString()
      var strLang = ""
      var strDate = this.state.daySet

      if(e == "more"){ //more results button was clicked
          var terms = this.state.query;
          var num = this.state.count + 10;
          strCount = num.toString();

          if(this.state.isChecked){ //box has been unchecked
              strLang = "&language=en";
          }else{ //box has been checked
            if(terms !== ""){
              strLang = "";
            }
          }

      } else if (e == "transl") { //english box changed
          var terms = this.state.query;

          if(this.state.isChecked){ //box has been unchecked
              strLang = "";
          }else{ //box has been checked
            if(terms !== ""){
              strLang = "&language=en";
            }
          }
      } else if (e == "time"){
         var terms = this.state.query;
         strDate = d
         if(terms !== ""){
           strLang=this.state.lang; //no lang for no query
         }

      } else {
          var terms = e.target.value;
          if(terms !== ""){
            strLang=this.state.lang; //no lang for no query
          }
          this.setState({query: terms});
      }

      setTimeout(() => {this.updateFetch(terms,strCount,strLang,strDate)}, 100); //} //fetching conflicts with state changes

      //this.updateFetch(terms,strCount,strLang,strDate)
      //const seqence = this.sequence

    }


    updateFetch(terms,strCount,strLang,strDate){

      var sequence = this.state.sequence+1;

      fetch("https://ssa-hw2-backend.stevetarzia.com/api/search?query="+terms+"&"+"count="+strCount+strLang+strDate)
        .then(response => response.json())
        .then(resultObj => this.setState({searchResults: resultObj}))
        /*.then(response => {
            if(seqence <comparison> this.sequence){
                                                  }
                          }
            )*/
        .catch(() => this.setState({searchResults: ""}));

    }

///////////////////////helper functions////////////////////////////////////////////////////////////////////////

    handleArticle(article, idx){ //unsused
      var title = article.title
      var txt = article.txt
      var url = article.url

      //var termIdx = txt.substring(txt.indexOf()) for highlighting
    }

    handleMore(e){ //more results
      this.setState({ count: this.state.count + 10 });
      this.handleType("more");
    }

    handleLess(e){ //more results
      this.setState({ count: 10 });
    }

    handleChecked(e){ //english only
      this.setState({isChecked: !this.state.isChecked});
      if(this.state.isChecked){ //box has been unchecked
          this.setState({lang:""});
      }else{ //box has been checked
          this.setState({lang:"&language=en"});
      }

      this.handleType("transl");
    }

    handleWrite(article){ //highlighting
      var title = article.title;
       var script = article.txt;
       var term = this.state.query;


       return script.substring(script.indexOf(term),script.indexOf(term)+100);

    }

    handleTime(e){
        this.setState({dayBox: e.target.value});
    }

    render() { //this.state.searchResults.article for iterable
      //variables
      const flattenedResults = JSON.stringify(this.state.searchResults.articles);
      const clickedString = this.state.clicked.toString();

      var results = this.state.searchResults; //"" or array of results,, [] if no matching



      return (
        <div>
          <br/><br/>




          <p style={{textAlign:"center"}}><input
                                           type="text"
                                           name="writing"
                                           onChange={this.handleType}
                                           placeholder="What are you looking for?"
                                           size="65" /> <input type="checkbox" id="English" onChange={this.handleChecked}/><label for="English">English Only</label></p>

          <div style={{textAlign:"center"}}><input type="date" onChange={this.handleTime} placeholder="YYYY-MM-DD" size="10"/>  <button onClick={this.handleClick}>Submit Date</button> </div>



          { (this.state.searchResults !== "" && this.state.searchResults.articles.length == 0)?this.handleLess():null
          }

          {
              this.state.searchResults !== ""? this.state.searchResults.articles.map((article) => <div className='box'><a href={article.url}>{article.title}</a><br/>{this.handleWrite(article)}<br/>{article.url}<br/><br/><br/></div>) : null
          }

          {this.state.searchResults !== "" && this.state.searchResults.articles.length !== 0 &&
              <div className='loader'>
                    <button
                          onClick={this.handleMore}>
                          10 more results
                    </button>
              </div>

          }


        </div>



      );
    }
  }

  // Use the ReactDOM.render to show your component on the browser
  ReactDOM.render(
    <SearchApp />,
    rootElement
  )
</script>

</body>

</html>
